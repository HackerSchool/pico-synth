#ifndef MIDI_HANDLER_HPP
#define MIDI_HANDLER_HPP

// #include "Synth.hpp"
#include "tusb.h"
#include <cstdint>

class Synth; // Forward declaration

#define MIDI_MIN 0
#define MIDI_MAX 127

const float midi_frequencies[MIDI_MAX + 1] = {
    8.1758f,    8.6610f,    9.1770f,   9.7227f,   10.3009f,   10.9134f,
    11.5623f,   12.2499f,   12.9783f,  13.7500f,  14.5676f,   15.4339f,
    16.3516f,   17.3239f,   18.3540f,  19.4454f,  20.6017f,   21.8268f,
    23.1247f,   24.4997f,   25.9565f,  27.5000f,  29.1352f,   30.8677f,
    32.7032f,   34.6478f,   36.7081f,  38.8909f,  41.2034f,   43.6535f,
    46.2493f,   48.9994f,   51.9131f,  55.0000f,  58.2705f,   61.7354f,
    65.4064f,   69.2957f,   73.4162f,  77.7817f,  82.4069f,   87.3071f,
    92.4986f,   97.9989f,   103.826f,  110.000f,  116.541f,   123.471f,
    130.813f,   138.591f,   146.832f,  155.563f,  164.814f,   174.614f,
    184.997f,   195.998f,   207.652f,  220.000f,  233.082f,   246.942f,
    261.626f,   277.183f,   293.665f,  311.127f,  329.628f,   349.228f,
    369.994f,   391.995f,   415.305f,  440.000f,  466.164f,   493.883f,
    523.251f,   554.365f,   587.330f,  622.254f,  659.255f,   698.456f,
    739.989f,   783.991f,   830.609f,  880.000f,  932.328f,   987.767f,
    1046.50f,   1108.73f,   1174.66f,  1244.51f,  1318.51f,   1396.91f,
    1479.98f,   1567.98f,   1661.22f,  1760.00f,  1864.66f,   1975.53f,
    2093.00f,   2217.46f,   2349.32f,  2489.02f,  2637.02f,   2793.83f,
    2959.96f,   3135.96f,   3322.44f,  3520.00f,  3729.31f,   3951.07f,
    4186.01f,   4434.92f,   4698.63f,  4978.03f,  5274.04f,   5587.65f,
    5919.91f,   6271.93f,   6644.88f,  7040.00f,  7458.62f,   7902.13f,
    8372.018f,  8869.844f,  9397.273f, 9956.063f, 10548.080f, 11175.300f,
    11839.820f, 12543.850f,
};

constexpr const char *midi_note_names[128] = {
    "C-1",  "C#-1", "D-1", "D#-1", "E-1", "F-1", "F#-1", "G-1", "G#-1", "A-1",
    "A#-1", "B-1",  "C0",  "C#0",  "D0",  "D#0", "E0",   "F0",  "F#0",  "G0",
    "G#0",  "A0",   "A#0", "B0",   "C1",  "C#1", "D1",   "D#1", "E1",   "F1",
    "F#1",  "G1",   "G#1", "A1",   "A#1", "B1",  "C2",   "C#2", "D2",   "D#2",
    "E2",   "F2",   "F#2", "G2",   "G#2", "A2",  "A#2",  "B2",  "C3",   "C#3",
    "D3",   "D#3",  "E3",  "F3",   "F#3", "G3",  "G#3",  "A3",  "A#3",  "B3",
    "C4",   "C#4",  "D4",  "D#4",  "E4",  "F4",  "F#4",  "G4",  "G#4",  "A4",
    "A#4",  "B4",   "C5",  "C#5",  "D5",  "D#5", "E5",   "F5",  "F#5",  "G5",
    "G#5",  "A5",   "A#5", "B5",   "C6",  "C#6", "D6",   "D#6", "E6",   "F6",
    "F#6",  "G6",   "G#6", "A6",   "A#6", "B6",  "C7",   "C#7", "D7",   "D#7",
    "E7",   "F7",   "F#7", "G7",   "G#7", "A7",  "A#7",  "B7",  "C8",   "C#8",
    "D8",   "D#8",  "E8",  "F8",   "F#8", "G8",  "G#8",  "A8",  "A#8",  "B8",
    "C9",   "C#9",  "D9",  "D#9",  "E9",  "F9",  "F#9",  "G9"};

// Function declaration (global access)
float midi_to_freq(uint8_t midi_note);

class MidiHandler {
  public:
    MidiHandler(Synth &synth);

    void midi_task();

  private:
    Synth &synth;
    uint32_t note_pos = 0;

    static const uint8_t note_sequence[64]; // Define in .cpp
};

#endif // MIDI_HANDLER_HPP
